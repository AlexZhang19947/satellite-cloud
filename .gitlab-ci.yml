stages:
  - build
  - deploy

variables:
  HARBOR_URL: "192.168.10.238"
  HARBOR_PROJECT: "satellite"
  BACKEND_IMAGE: "$HARBOR_URL/$HARBOR_PROJECT/backend:$CI_COMMIT_SHORT_SHA"
  FRONTEND_IMAGE: "$HARBOR_URL/$HARBOR_PROJECT/frontend:$CI_COMMIT_SHORT_SHA"
  DOCKER_DRIVER: overlay2

# 构建并推送后端镜像
build-backend:
  stage: build
  image: docker:25.0
  services:
    - docker:25.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - |
      if [ -z "$HARBOR_USER" ] || [ -z "$HARBOR_PASSWORD" ]; then
        echo "HARBOR_USER 或 HARBOR_PASSWORD 未配置（建议在 GitLab CI/CD Variables 中配置同名变量）"
        exit 1
      fi
    - docker login "$HARBOR_URL" -u "$HARBOR_USER" -p "$HARBOR_PASSWORD"
    - cd backend
    - docker build -t "$BACKEND_IMAGE" .
    - docker push "$BACKEND_IMAGE"
  tags:
    - k8s-cluster-runner
  only:
    - main

# 构建并推送前端镜像
build-frontend:
  stage: build
  image: docker:25.0
  services:
    - docker:25.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - |
      if [ -z "$HARBOR_USER" ] || [ -z "$HARBOR_PASSWORD" ]; then
        echo "HARBOR_USER 或 HARBOR_PASSWORD 未配置（建议在 GitLab CI/CD Variables 中配置同名变量）"
        exit 1
      fi
    - docker login "$HARBOR_URL" -u "$HARBOR_USER" -p "$HARBOR_PASSWORD"
    - cd frontend
    - docker build -t "$FRONTEND_IMAGE" .
    - docker push "$FRONTEND_IMAGE"
  tags:
    - k8s-cluster-runner
  only:
    - main

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "部署到 namespace=gitlab-runner"
    # 应用/更新后端 Deployment + Service
    - kubectl -n gitlab-runner apply -f k8s/backend/deployment.yaml
    - kubectl -n gitlab-runner set image deployment/satellite-backend satellite-backend="$BACKEND_IMAGE"
    - kubectl -n gitlab-runner rollout status deployment/satellite-backend
    # 应用/更新前端 Deployment + Service
    - kubectl -n gitlab-runner apply -f k8s/frontend/deployment.yaml
    - kubectl -n gitlab-runner set image deployment/satellite-frontend satellite-frontend="$FRONTEND_IMAGE"
    - kubectl -n gitlab-runner rollout status deployment/satellite-frontend
    # Istio Gateway + VirtualService（需预先执行一次：kubectl apply -f k8s/istio-rbac-gitlab-runner.yaml）
    - kubectl apply -f k8s/istio-rbac-gitlab-runner.yaml
    # 以授权 gitlab-runner 在 istio-system 中创建 Gateway/VirtualService
    - kubectl apply -f k8s/istio-gateway.yaml
    - kubectl apply -f k8s/istio-virtualservice.yaml
  tags:
    - k8s-cluster-runner
  needs:
    - build-backend
    - build-frontend
  only:
    - main
