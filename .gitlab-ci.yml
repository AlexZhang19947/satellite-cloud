stages:
  - build
  - deploy

variables:
  HARBOR_URL: "192.168.10.238"
  HARBOR_PROJECT: "satellite"
  BACKEND_IMAGE: "$HARBOR_URL/$HARBOR_PROJECT/backend:$CI_COMMIT_SHORT_SHA"
  FRONTEND_IMAGE: "$HARBOR_URL/$HARBOR_PROJECT/frontend:$CI_COMMIT_SHORT_SHA"
  DOCKER_DRIVER: overlay2
  HARBOR_USER: "admin"
  HARBOR_PASSWORD: "Harbor12345"

# 构建并推送后端镜像
build-backend:
  stage: build
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - docker login -u "$HARBOR_USER" --password-stdin "$HARBOR_URL"
    - cd backend
    - docker build -t "$BACKEND_IMAGE" .
    - docker push "$BACKEND_IMAGE"
  tags:
    - k8s-cluster-runner
  only:
    - main

# 构建并推送前端镜像
build-frontend:
  stage: build
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USER" --password-stdin "$HARBOR_URL"
    - cd frontend
    - docker build -t "$FRONTEND_IMAGE" .
    - docker push "$FRONTEND_IMAGE"
  tags:
    - k8s-cluster-runner
  only:
    - main

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "部署到 namespace=gitlab-runner"
    # 应用/更新后端 Deployment + Service
    - kubectl -n gitlab-runner apply -f k8s/backend/deployment.yaml
    - kubectl -n gitlab-runner set image deployment/satellite-backend satellite-backend="$BACKEND_IMAGE"
    - kubectl -n gitlab-runner rollout status deployment/satellite-backend
    # 应用/更新前端 Deployment + Service
    - kubectl -n gitlab-runner apply -f k8s/frontend/deployment.yaml
    - kubectl -n gitlab-runner set image deployment/satellite-frontend satellite-frontend="$FRONTEND_IMAGE"
    - kubectl -n gitlab-runner rollout status deployment/satellite-frontend
  tags:
    - k8s-cluster-runner
  needs:
    - build-backend
    - build-frontend
  only:
    - main
